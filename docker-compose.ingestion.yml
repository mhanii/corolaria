# Docker Compose for Coloraria Ingestion Pipeline
# Run: docker compose -f docker-compose.ingestion.yml up

services:
  neo4j:
    image: neo4j:5-community
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4JLABS_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: [ "CMD", "bash", "-c", "echo > /dev/tcp/localhost/7687" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s

  ingestion:
    build:
      context: .
      dockerfile: Dockerfile.ingestion
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
      # Neo4j connection (uses Docker DNS)
      NEO4J_URI: neo4j://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password

      # Enable free-threading (No-GIL)
      PYTHON_GIL: "0"

      # Google AI API key (required for embeddings)
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}

      # Worker pool configuration
      INGESTION_CPU_WORKERS: ${INGESTION_CPU_WORKERS:-5}
      INGESTION_NETWORK_WORKERS: ${INGESTION_NETWORK_WORKERS:-20}
      INGESTION_DISK_WORKERS: ${INGESTION_DISK_WORKERS:-2}
      INGESTION_SCATTER_CHUNK_SIZE: ${INGESTION_SCATTER_CHUNK_SIZE:-500}

      # Observability
      PHOENIX_ENABLED: "false"
    volumes:
      # Persist SQLite embedding cache across container rebuilds
      - ./data:/app/data
      # Mount source code for development (no rebuild needed for code changes)
      - ./src:/app/src:ro
      - ./config:/app/config:ro

volumes:
  neo4j_data:
