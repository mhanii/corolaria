# Docker Compose for Coloraria Infrastructure
# Databases only: Neo4j (graph) + MariaDB (relational)
#
# Usage:
#   docker compose -f docker-compose.infrastructure.yml up -d
#
# Both API and Ingestion connect to this network

services:
  neo4j:
    image: neo4j:5-community
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD}
      NEO4JLABS_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
      NEO4J_dbms_memory_heap_initial__size: ${NEO4J_HEAP_SIZE:- 4G}
      NEO4J_dbms_memory_heap_max__size: ${NEO4J_HEAP_SIZE:-6G}
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: [ "CMD", "bash", "-c", "echo > /dev/tcp/localhost/7687" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - coloraria

  mariadb:
    image: mariadb:10.11
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MYSQL_DATABASE: coloraria
      MYSQL_USER: coloraria_user
      MYSQL_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - coloraria

  phoenix:
    image: arizephoenix/phoenix:latest
    restart: unless-stopped
    ports:
      - "6006:6006"   # Web UI + OTLP HTTP
    environment:
      PHOENIX_WORKING_DIR: /data
    volumes:
      - phoenix_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:6006/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - coloraria

networks:
  coloraria:
    name: coloraria_network
    driver: bridge

volumes:
  neo4j_data:
  mariadb_data:
  phoenix_data:
