# Docker Compose for Coloraria Ingestion Pipeline (Production)
# Code baked in - connects to external infrastructure network
#
# Prerequisites: 
#   docker compose -f docker-compose.infrastructure.yml up -d
#
# Usage:
#   docker compose -f docker-compose.ingestion.prod.yml run --rm ingestion --batch /app/data/laws.txt --decoupled

services:
  ingestion:
    build:
      context: .
      dockerfile: Dockerfile.ingestion
    image: coloraria-ingestion:latest
    environment:
      # Neo4j connection (infrastructure network)
      NEO4J_URI: neo4j://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}

      # Enable free-threading (No-GIL)
      PYTHON_GIL: "0"

      # Google AI API key
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}

      # Worker pool configuration
      INGESTION_CPU_WORKERS: ${INGESTION_CPU_WORKERS:-12}
      INGESTION_NETWORK_WORKERS: ${INGESTION_NETWORK_WORKERS:-3}
      INGESTION_DISK_WORKERS: ${INGESTION_DISK_WORKERS:-12}
      INGESTION_SCATTER_CHUNK_SIZE: ${INGESTION_SCATTER_CHUNK_SIZE:-1000}

      # Observability
      PHOENIX_ENABLED: ${PHOENIX_ENABLED:-false}
      PHOENIX_ENDPOINT: ${PHOENIX_ENDPOINT:-}
    volumes:
      # Shared data directory (same as API)
      - ${SHARED_DATA_PATH:-./data}:/app/data
    networks:
      - coloraria

networks:
  coloraria:
    name: coloraria_network
    external: true
