# Docker Compose for Coloraria Ingestion Pipeline (Development)
# Mounts source code - connects to external infrastructure network
#
# Prerequisites: 
#   docker compose -f docker-compose.infrastructure.yml up -d
#
# Usage:
#   docker compose -f docker-compose.ingestion.dev.yml run --rm ingestion --help

services:
  ingestion:
    build:
      context: .
      dockerfile: Dockerfile.ingestion
    environment:
      # Neo4j connection (infrastructure network)
      NEO4J_URI: neo4j://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}

      # Enable free-threading (No-GIL)
      PYTHON_GIL: "0"

      # Google AI API key
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}

      # Worker pool configuration
      INGESTION_CPU_WORKERS: ${INGESTION_CPU_WORKERS:-6}
      INGESTION_NETWORK_WORKERS: ${INGESTION_NETWORK_WORKERS:-3}
      INGESTION_DISK_WORKERS: ${INGESTION_DISK_WORKERS:-6}
      INGESTION_SCATTER_CHUNK_SIZE: ${INGESTION_SCATTER_CHUNK_SIZE:-1000}

      # Observability
      PHOENIX_ENABLED: "false"
    volumes:
      # Shared data directory (same as API)
      - ${SHARED_DATA_PATH:-./data}:/app/data
      # Mount source code (DEV ONLY)
      - ./src:/app/src:ro
      - ./config:/app/config:ro
    networks:
      - coloraria

networks:
  coloraria:
    name: coloraria_network
    external: true
